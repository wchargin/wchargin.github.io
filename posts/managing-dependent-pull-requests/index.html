<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="shortcut icon" href="/favicon.png" sizes="16x16" />
<link rel="shortcut icon" href="/favicon-256.png" sizes="256x256" />
<link rel="apple touch icon" href="/favicon-256.png" />
<title>Managing dependent pull requests</title>
<style>/*! normalize.css v4.1.1 | MIT License | github.com/necolas/normalize.css */
html{font-family:sans-serif;line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress,sub,sup{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline dotted}b,strong{font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,hr,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{color:inherit;display:table;max-width:100%;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio],legend{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}</style>
<style>p{margin-top:0}</style>
<style>code .comment{color:#6e6e6e}code:not([data-hide-strings]) .string{color:#6e6e6e}code .important{font-style:italic}code .keyword{font-weight:700}code .prompt,code .tt{font-family:monospace}code .prompt{user-select:none}code .property,code .property+.punctuation{font-weight:700}code .tag .tag:first-child{font-weight:700}code .punctuation{font-weight:400}</style>
<style data-aphrodite>._684hqj{font-family:Helvetica, Arial, sans-serif;font-size:16px;color:#121316;line-height:1.5;}._4nzfye{position:fixed;z-index:-1;top:0px;bottom:0px;width:-webkit-calc(max(400px, 50vw - 420px));width:-moz-calc(max(400px, 50vw - 420px));width:calc(max(400px, 50vw - 420px));left:-webkit-calc(50vw - 420px - max(400px, 50vw - 420px));left:-moz-calc(50vw - 420px - max(400px, 50vw - 420px));left:calc(50vw - 420px - max(400px, 50vw - 420px));background:url(/static/skygradopaque.bef44f7824d5.jpg), -webkit-linear-gradient(to bottom, #9eabbc 0%, #aebbc3 47%, #c1c0b4 73%, #c3af97 89%, #bd987e 100%);background:url(/static/skygradopaque.bef44f7824d5.jpg), -moz-linear-gradient(to bottom, #9eabbc 0%, #aebbc3 47%, #c1c0b4 73%, #c3af97 89%, #bd987e 100%);background:url(/static/skygradopaque.bef44f7824d5.jpg), linear-gradient(to bottom, #9eabbc 0%, #aebbc3 47%, #c1c0b4 73%, #c3af97 89%, #bd987e 100%);background-size:100% 100%;-webkit-mask-image:-webkit-linear-gradient(to right, rgb(0 0 0 / 100%), rgb(0 0 0 / 50%) 25%, transparent);-webkit-mask-image:-moz-linear-gradient(to right, rgb(0 0 0 / 100%), rgb(0 0 0 / 50%) 25%, transparent);-webkit-mask-image:linear-gradient(to right, rgb(0 0 0 / 100%), rgb(0 0 0 / 50%) 25%, transparent);mask-image:-webkit-linear-gradient(to right, rgb(0 0 0 / 100%), rgb(0 0 0 / 50%) 25%, transparent);mask-image:-moz-linear-gradient(to right, rgb(0 0 0 / 100%), rgb(0 0 0 / 50%) 25%, transparent);mask-image:linear-gradient(to right, rgb(0 0 0 / 100%), rgb(0 0 0 / 50%) 25%, transparent);}._1qcuqeh{position:absolute;z-index:-1;top:0px;right:-webkit-calc(50vw + 420px);right:-moz-calc(50vw + 420px);right:calc(50vw + 420px);opacity:0.25;}._37ihjp{border-top:#046375 5px solid;border-bottom:0.5px #cecece solid;margin-bottom:24px;padding-top:10px;padding-bottom:10px;}._tcz2umt{-webkit-box-align:center;-ms-flex-align:center;-webkit-box-pack:justify;-ms-flex-pack:justify;max-width:800px;margin:auto;padding-left:20px;padding-right:20px;display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;align-items:center;margin-top:10px;margin-bottom:10px;}._odt2os{font-size:24px;letter-spacing:-0.5px;color:#222;}._1yyogy7{max-width:800px;margin:auto;padding-left:20px;padding-right:20px;}._1gtwn3{color:#6e6e6e;border-top:0.5px #cecece solid;margin-top:24px;padding-top:24px;padding-bottom:24px;}._16597jh{text-decoration:none;color:#0a7f96;}._16597jh:hover{color:#046375;text-decoration:underline;}._16597jh:active{color:#0a7f96;text-decoration:underline;}._1rq9psi{list-style:none;padding-left:0px;margin:0px;}._txtyvv{display:inline;margin-left:20px;}._nqjtz2{margin-top:30px;margin-bottom:10px;font-size:32px;font-weight:normal;}._1htp0dj{margin-top:26px;margin-bottom:8px;font-size:24px;font-weight:normal;}._gy9i19{margin:16px;overflow-x:auto;background:rgba(10,127,150,0.1);border-left:#0a7f96 2px solid;padding:16px;line-height:140%;}._1napz9l{font-family:Helvetica,Arial,sans-serif;}._1ucarsym{font-family:Helvetica,Arial,sans-serif;padding:2px 4px;background:rgba(10,127,150,0.1);white-space:pre-wrap;}</style>
<noscript><style>.yesscript{display:none;}</style></noscript>
</head>
<body style="overflow-y:scroll">
<div id="container"><div class="_684hqj"><div class="_4nzfye"></div><img class="_1qcuqeh" src="/static/leaves.3557bb6ea277.png" width="226" height="400" alt=""/><header class="_37ihjp"><nav class="_tcz2umt"><a class="_odt2os _16597jh" href="/">wchargin</a><ul class="_1rq9psi"><li class="_txtyvv"><a class="_16597jh" href="/"><svg width="14" height="14" viewBox="0 0 16 16" alt="Home" aria-label="Home"><path fill="currentColor" d="M15.45,7L14,5.551V2c0-0.55-0.45-1-1-1h-1c-0.55,0-1,0.45-1,1v0.553L9,0.555C8.727,0.297,8.477,0,8,0S7.273,0.297,7,0.555  L0.55,7C0.238,7.325,0,7.562,0,8c0,0.563,0.432,1,1,1h1v6c0,0.55,0.45,1,1,1h3v-5c0-0.55,0.45-1,1-1h2c0.55,0,1,0.45,1,1v5h3  c0.55,0,1-0.45,1-1V9h1c0.568,0,1-0.437,1-1C16,7.562,15.762,7.325,15.45,7z"></path></svg></a></li><li class="_txtyvv"><a class="_16597jh" href="/posts/">Posts</a></li></ul></nav></header><article class="_1yyogy7"><div><a style="margin-bottom:10px;margin-top:10px" class="_16597jh" href="/posts"><i>« back to posts</i></a><article><div><h1 class="_nqjtz2">Managing dependent pull requests</h1><p><i>2017-07-28</i> <!-- -->·<!-- --> <i><a href="https://github.com/wchargin/wchargin.github.io/blob/source/src/pages/posts/data/gitWorkflow.js" class="_16597jh">view article source</a></i></p></div><p>In this article, I’ll describe some of my experiences managing <em>dependent pull requests</em>: sequences of pull requests where each pull request is based off the previous pull request. Such sequences arise naturally as a consequence of using many small commits to develop a feature. We’ll discover (or re-discover!) some problems that frequently arise, and develop an elegant, systematic solution that works with GitHub’s code review system.</p><h2 class="_1htp0dj">Problems in a one-branch-per-change model</h2><p>GitHub’s code review system requires that each pull request correspond to exactly one branch. More precisely, each pull request is a request to merge one source branch into one base branch. Let’s explore how this restriction impacts dependent pull requests.</p><p>Consider the following stack of dependent commits, which is a representative example from my work:</p><pre class="_gy9i19"><code class="_1napz9l"><span class="token pick-action">pick</span> <span class="token sha constant">a2cc9d8</span> <span class="token commit-description comment">Centralize a `markdown_to_safe_html` function</span>
<span class="token pick-action">pick</span> <span class="token sha constant">1e266ba</span> <span class="token commit-description comment">Centralize a `tf-markdown-view` component</span>
<span class="token pick-action">pick</span> <span class="token sha constant">7574aa5</span> <span class="token commit-description comment">Display summaries' `displayName` and `description`</span>
<span class="token pick-action">pick</span> <span class="token sha constant">f42c879</span> <span class="token commit-description comment">Introduce `data_compat`, legacy summary converter</span>
<span class="token pick-action">pick</span> <span class="token sha constant">7826d74</span> <span class="token commit-description comment">Remove histogram compression from TensorBoard core</span>
<span class="token pick-action">pick</span> <span class="token sha constant">5c8c500</span> <span class="token commit-description comment">Perform legacy event conversion with `data_compat`</span>
</code></pre><p>Each of these commits depends on some nonempty subset of the commits preceding it. If we were using a naive GitHub workflow, we would have a branch <code class="_1ucarsym">markdown-to-safe-html</code> at commit <code class="_1ucarsym">a2cc9d8</code>, and a branch <code class="_1ucarsym">tf-markdown-view</code> at commit <code class="_1ucarsym">1e266ba</code>, and so on.</p><p>Now, suppose that we want to edit the third commit, <code class="_1ucarsym">7574aa5</code>. We check out our <code class="_1ucarsym">show-display-name-and-description</code> branch and amend the commit, then force-push to the branch, which properly updates the corresponding PR. But now the next PR is in a bad state: its commit <code class="_1ucarsym">f42c879</code> has parent <code class="_1ucarsym">7574aa5</code>, not the amended version that we just force-pushed, so it will show an incorrect diff.</p><p>The fix is simple: we check out the branch <code class="_1ucarsym">data-compat</code> corresponding to the commit <code class="_1ucarsym">f42c879</code>, and we rebase it onto <code class="_1ucarsym">7574aa5</code>, force-pushing freely. But of course this just propagates the problem one commit further. We must rebase-and-push each of <code class="_1ucarsym">7826d74</code> and <code class="_1ucarsym">5c8c500</code> as well before the remote repository will be in the correct state.</p><p>Let’s take a step back to evaluate. The fundamental problem is that <strong>to make a single change, we needed to perform work linear in the number of commits,</strong> and furthermore the constant factors were high. This is unacceptable: editing a file <em>must</em> be an absolutely efficient operation.</p><h2 class="_1htp0dj">Developing a solution using locally linear history</h2><p>Let’s return to our original rebase log.</p><pre class="_gy9i19"><code class="_1napz9l"><span class="token pick-action">pick</span> <span class="token sha constant">a2cc9d8</span> <span class="token commit-description comment">Centralize a `markdown_to_safe_html` function</span>
<span class="token pick-action">pick</span> <span class="token sha constant">1e266ba</span> <span class="token commit-description comment">Centralize a `tf-markdown-view` component</span>
<span class="token pick-action">pick</span> <span class="token sha constant">7574aa5</span> <span class="token commit-description comment">Display summaries' `displayName` and `description`</span>
<span class="token pick-action">pick</span> <span class="token sha constant">f42c879</span> <span class="token commit-description comment">Introduce `data_compat`, legacy summary converter</span>
<span class="token pick-action">pick</span> <span class="token sha constant">7826d74</span> <span class="token commit-description comment">Remove histogram compression from TensorBoard core</span>
<span class="token pick-action">pick</span> <span class="token sha constant">5c8c500</span> <span class="token commit-description comment">Perform legacy event conversion with `data_compat`</span>
</code></pre><p>Forget for a moment everything you know about branches. Suppose that we have our <code class="_1ucarsym">HEAD</code> pointing to <code class="_1ucarsym">5c8c500</code>—say, on a branch called <code class="_1ucarsym">develop</code>—and that there are no other relevant branches. Now, suppose that we want to make the same change as before, editing commit <code class="_1ucarsym">7574aa5</code>. We can simply use an interactive rebase to edit this commit in place:</p><pre class="_gy9i19"><code class="_1napz9l"><span class="token pick-action">pick</span> <span class="token sha constant">a2cc9d8</span> <span class="token commit-description comment">Centralize a `markdown_to_safe_html` function</span>
<span class="token pick-action">pick</span> <span class="token sha constant">1e266ba</span> <span class="token commit-description comment">Centralize a `tf-markdown-view` component</span>
<span class="token non-pick-action keyword">edit</span> <span class="token sha constant">7574aa5</span> <span class="token commit-description comment">Display summaries' `displayName` and `description`</span>
<span class="token pick-action">pick</span> <span class="token sha constant">f42c879</span> <span class="token commit-description comment">Introduce `data_compat`, legacy summary converter</span>
<span class="token pick-action">pick</span> <span class="token sha constant">7826d74</span> <span class="token commit-description comment">Remove histogram compression from TensorBoard core</span>
<span class="token pick-action">pick</span> <span class="token sha constant">5c8c500</span> <span class="token commit-description comment">Perform legacy event conversion with `data_compat`        </span></code></pre><p>Here is a quick crash course on interactive rebases, in case you’re not familiar. Given the above commands, git will first <em>remove</em> all the commits above, reverting the state to that of (say) <code class="_1ucarsym">origin/master</code>. For each commit that you “pick”, git will apply that commit in place: so, if you write “pick” at every commit, then you will end up with the same thing that you started with, as git strips away all the commits and puts them back one by one. But if you say “edit” then git will instead pause the rebase, allowing you to change the commit however you want. You can change the contents and/or the commit message and then simply amend the commit. When you execute <code class="_1ucarsym">git rebase --continue</code>, git simply continues where it left off, applying the rest of the commits one by one. The result is exactly what we want: you get to edit the commit in question, and then the later commits are re-applied on top of it. (If there are any merge conflicts, you’ll have the chance to apply them along the way.)</p><p>This lets us efficiently maintain our local state: we do only a constant amount of work, no matter how deep our stack is. This is good progress! However, it doesn’t answer the question of integrating with GitHub’s one-branch-per-change model. After all, we have six changes but only one branch among them! The trick is to realize that <strong>the branches on the client don’t have to correspond to the branches on the server.</strong> <!-- -->Indeed, we can simply write the following in a shell:</p><pre class="_gy9i19"><code class="_1napz9l">git push origin --force-with-lease \
    7574aa6:refs/heads/show-display-name-and-description
</code></pre><p>This instructs git to push our commit <code class="_1ucarsym">7574aa6</code> to a remote branch called <code class="_1ucarsym">show-display-name-and-description</code>; using <code class="_1ucarsym">refs/heads/</code> ensures that it&#x27;s created if it doesn&#x27;t yet exist. So we could create the proper state on the remote by pushing each commit in turn:</p><pre class="_gy9i19"><code class="_1napz9l">git push origin --force-with-lease \
    7574aa6:refs/heads/show-display-name-and-description \
    f42c87a:refs/heads/data-compat \
    7826d75:refs/heads/encapsulate-histogram-compression \
    5c8c501:refs/heads/use-data-compat \
    ;
</code></pre><p>While this does get the job done, it is also a terrible solution. Not only does it require linear work in the form of manually specifying SHAs and branch names for each commit, it is severely error-prone. A typo in a branch name means silently pushing to a different branch, resulting in the update being (temporarily) “lost” for that PR; a permutation of two SHAs or branches is even worse, swapping the commits of two PRs. We must do better.</p><p>First, we can save having to write out the commit SHAs by adding “exec” directives to our rebase, as follows:</p><pre class="_gy9i19"><code class="_1napz9l"><span class="token pick-action">pick</span> <span class="token sha constant">a2cc9d8</span> <span class="token commit-description comment">Centralize a `markdown_to_safe_html` function</span>
<span class="token pick-action">pick</span> <span class="token sha constant">1e266ba</span> <span class="token commit-description comment">Centralize a `tf-markdown-view` component</span>
<span class="token pick-action">pick</span> <span class="token sha constant">7574aa5</span> <span class="token commit-description comment">Display summaries' `displayName` and `description`</span>
<span class="token non-pick-action keyword">exec</span> <span class="token exec-target">git push --force-with-lease origin HEAD:refs/heads/show-display-name-and-description</span>
<span class="token pick-action">pick</span> <span class="token sha constant">f42c879</span> <span class="token commit-description comment">Introduce `data_compat`, legacy summary converter</span>
<span class="token non-pick-action keyword">exec</span> <span class="token exec-target">git push --force-with-lease origin HEAD:refs/heads/data-compat</span>
<span class="token pick-action">pick</span> <span class="token sha constant">7826d74</span> <span class="token commit-description comment">Remove histogram compression from TensorBoard core</span>
<span class="token non-pick-action keyword">exec</span> <span class="token exec-target">git push --force-with-lease origin HEAD:refs/heads/encapsulate-histogram-compression</span>
<span class="token pick-action">pick</span> <span class="token sha constant">5c8c500</span> <span class="token commit-description comment">Perform legacy event conversion with `data_compat`</span>
<span class="token non-pick-action keyword">exec</span> <span class="token exec-target">git push --force-with-lease origin HEAD:refs/heads/use-data-compat</span>
</code></pre><p>The “exec” directive in a rebase does just what it says on the tin: it runs the following shell command at the relevant commit. It’s equivalent to using the “edit” directive, executing the shell command manually, and then (if the command succeeded) immediately continuing the rebase. Thus, we can substitute the replace SHAs with <code class="_1ucarsym">HEAD</code>, instructing git to always push “the current commit, whatever that is” to the specified branch.</p><p>Better: less catastrophically error-prone. But error-prone nonetheless—we could incorrectly remember or type the branch names—and certainly not good enough.</p><p>At this point, I’ll present the solution that I use, and then explain how it works:</p><pre class="_gy9i19"><code class="_1napz9l"><span class="token pick-action">pick</span> <span class="token sha constant">a2cc9d8</span> <span class="token commit-description comment">Centralize a `markdown_to_safe_html` function</span>
<span class="token pick-action">pick</span> <span class="token sha constant">1e266ba</span> <span class="token commit-description comment">Centralize a `tf-markdown-view` component</span>
<span class="token pick-action">pick</span> <span class="token sha constant">7574aa5</span> <span class="token commit-description comment">Display summaries' `displayName` and `description`</span>
<span class="token non-pick-action keyword">exec</span> <span class="token exec-target">git push-to-target</span>
<span class="token pick-action">pick</span> <span class="token sha constant">f42c879</span> <span class="token commit-description comment">Introduce `data_compat`, legacy summary converter</span>
<span class="token non-pick-action keyword">exec</span> <span class="token exec-target">git push-to-target</span>
<span class="token pick-action">pick</span> <span class="token sha constant">7826d74</span> <span class="token commit-description comment">Remove histogram compression from TensorBoard core</span>
<span class="token non-pick-action keyword">exec</span> <span class="token exec-target">git push-to-target</span>
<span class="token pick-action">pick</span> <span class="token sha constant">5c8c500</span> <span class="token commit-description comment">Perform legacy event conversion with `data_compat`</span>
<span class="token non-pick-action keyword">exec</span> <span class="token exec-target">git push-to-target</span>
</code></pre><p>(It’s worth nothing that I have configured my editor so that typing <code class="_1ucarsym">&lt;Space>grp</code> (“git-rebase-push”) inserts the string <code class="_1ucarsym">exec git push-to-target</code> and moves to the next line, so creating this rebase file only involves moving to the third line and then hitting that key sequence four times. It’s very fast.)</p><p>You should be asking yourself what <code class="_1ucarsym">git push-to-target</code> is. It is certainly not a standard git utility, but it is the crux of this solution.</p><h2 class="_1htp0dj"><code class="_1ucarsym">git-push-to-target</code></h2><p><code class="_1ucarsym">git-push-to-target</code> is a very small shell script that does the following:</p><ol><li>Look in the commit description for a unique line starting with the string <code class="_1ucarsym">wchargin-branch: </code> and followed by a <em>branch basename</em> matching the pattern <code class="_1ucarsym">[A-Za-z0-9_.-]+</code>.</li><li>Prepend <code class="_1ucarsym">wchargin-</code> to this string to get the <em>qualified branch</em>.</li><li>Force-push the current commit to the qualified branch.</li></ol><p>Therefore, my process when writing a commit message is as follows. In addition to writing the commit title, summary, and test plan, I also include one line with a branch directive. It is at this point that I name the branch that will be thenceforth associated with the commit, and <strong>the commit description is the single source of truth.</strong></p><p>In retrospect, this is not an entirely novel idea. Existing code review systems store similar information in the commit description: for instance, Phabricator adds a “Differential Revision:” line that serves much the same purpose. However, this application is interesting in that it’s not tied to any particular system, as are Phabricator, Gerrit, and the like: it works with any system that wants to use branches as its source of truth. In effect, it serves as an adapter between two sources of truth, enabling you to work comfortably on your local machine while the remote host is no wiser.</p><p>We should check whether we have achieved our goals. When we want to make a single change to a commit in an arbitrary location in the stack, we rebase once to make the change: this takes constant work. Then, we rebase again and execute <code class="_1ucarsym">git push-to-target</code> at each commit. In my implementation, this technically takes linear work, but the constant factor is tiny: it easily takes less than half a second to hit <code class="_1ucarsym">&lt;Space>grp</code> and insert the desired text. Plus, you could easily configure your editor to “insert <code class="_1ucarsym">git push-to-target</code> after each line from here to the end of the document”, truly requiring only constant work from the user. We do specify an extra parameter in the commit message, but on the other hand we don’t have to manually create branches anywhere, so this isn’t really any time lost. Indeed, this complexity is rather unavoidable: if we are required to use branches on the remote (which we are) and we want the branch names on the remote to be human-readable (which we do), then we should take the few seconds to specify the branch names ourselves. In summary, then, this solution meets all our criteria.</p><h2 class="_1htp0dj">Code</h2><p>To use <code class="_1ucarsym">git push-to-target</code>, simply create an executable file called <code class="_1ucarsym">git-push-to-target</code> on your <code class="_1ucarsym">$PATH</code>, with the following contents (changing the two global variables appropriately, of course):</p><pre class="_gy9i19"><code class="_1napz9l" data-hide-strings="true"><span class="token shebang important">#!/bin/sh</span>
<span class="token comment">#</span>
<span class="token comment"># git-push-to-target: Push this commit to a branch specified in its</span>
<span class="token comment"># commit description.</span>
<span class="token comment">#</span>
<span class="token comment"># Copyright (c) 2017 wchargin. Released under the MIT license.</span>

<span class="token keyword">set</span> -eu

DIRECTIVE<span class="token operator">=</span><span class="token string">'wchargin-branch'</span>  <span class="token comment"># any regex metacharacters should be escaped</span>
BRANCH_PREFIX<span class="token operator">=</span><span class="token string">'wchargin-'</span>

target_branch<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    directive<span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span> \
        <span class="token function">git</span> show --pretty<span class="token operator">=</span><span class="token string">'%B'</span> \
        <span class="token operator">|</span> <span class="token function">sed</span> -n <span class="token string">'s/^'</span><span class="token string">"<span class="token variable">${DIRECTIVE}</span>"</span>': \<span class="token punctuation">(</span><span class="token punctuation">[</span>A-Za-z0-9_.-<span class="token punctuation">]</span>\+\<span class="token variable">)</span></span>$/\1/p' \
        ; )"</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> -z <span class="token string">"<span class="token variable">${directive}</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token function">printf</span> <span class="token operator">></span><span class="token operator">&amp;</span>2 <span class="token string">'error: missing "%s" directive\n'</span> <span class="token string">"<span class="token variable">${DIRECTIVE}</span>"</span>
        <span class="token keyword">return</span> 1
    <span class="token keyword">fi</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">printf</span> <span class="token string">'%s\n'</span> <span class="token string">"<span class="token variable">${directive}</span>"</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">)</span></span>"</span> -gt 1 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token function">printf</span> <span class="token operator">></span><span class="token operator">&amp;</span>2 <span class="token string">'error: multiple "%s" directives\n'</span> <span class="token string">"<span class="token variable">${DIRECTIVE}</span>"</span>
        <span class="token keyword">return</span> 1
    <span class="token keyword">fi</span>
    <span class="token function">printf</span> <span class="token string">'%s%s\n'</span> <span class="token string">"<span class="token variable">${BRANCH_PREFIX}</span>"</span> <span class="token string">"<span class="token variable">${directive}</span>"</span>
<span class="token punctuation">}</span>

main<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">${1:-}</span>"</span> <span class="token operator">=</span> <span class="token string">"--query"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        target_branch
        <span class="token keyword">return</span>
    <span class="token keyword">fi</span>
    remote<span class="token operator">=</span><span class="token string">"<span class="token variable">${1:-origin}</span>"</span>
    branch<span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>target_branch<span class="token variable">)</span></span>"</span>
    <span class="token keyword">set</span> -x
    <span class="token function">git</span> push --force-with-lease <span class="token string">"<span class="token variable">${remote}</span>"</span> HEAD:refs/heads/<span class="token string">"<span class="token variable">${branch}</span>"</span>
<span class="token punctuation">}</span>

main <span class="token string">"<span class="token variable">$@</span>"</span>
</code></pre><p>I also recommend using <code class="_1ucarsym">git config --global alias.pt push-to-target</code> so that you can more easily use this command manually. As mentioned above, it would be foolish not to configure your editor to insert this string on a dime.</p><h2 class="_1htp0dj">In practice</h2><p>I’ve used this scheme exclusively for a few months now. Here are some of my observations.</p><ul><li>It works really well! I was initially nervous about having a script that automatically force-pushed to a dynamically generated branch name, but I’ve never had any problems with it.</li><li>I still use branches: I have a single branch for each stack of dependent commits. (This usually corresponds to “one branch per feature”.) It is worth noting that this model is fully compatible with having multiple independent stacks of dependent commits, and indeed this is very useful for moving more quickly on commits that truly are independent.</li><li>In GitHub’s interface, there is one extra constant term of overhead each time that you <em>merge</em> a pull request at the base of the stack: you have to change the base branch of the next PR in the stack to <code class="_1ucarsym">master</code> (or whatever you merged into). This solution does not address this issue, but the issue is not too big of a deal—although it is annoying, to be sure, and I would be much relieved were it to be fixed.</li><li>My goal has always been to optimize the amount of work that the <em>developer</em> has to do, but it is worth noting that this solution requires O(<i>n</i>) new commits to edit a commit in an <i>n</i>-deep stack. When all these branches are pushed to the remote so that their various pull requests can stay in sync, it’s possible for many post-push hooks, such as continuous integration jobs, to be triggered. To some degree, this makes sense: if a commit changes, then later commits in theory need to be retested. However, due to the nature of reviews, such changes are often non-functional (documentation clarifications, minor linewise refactorings, small changes to test cases) and in these cases the extra builds feel wasteful. I’ve not yet come up with a good solution to this problem.</li></ul></article><a style="margin-bottom:10px;margin-top:10px" class="_16597jh" href="/posts"><i>« back to posts</i></a></div></article><footer class="_1gtwn3"><div class="_1yyogy7"><a href="https://github.com/wchargin" class="_16597jh"><svg width="16" height="16" style="vertical-align:middle" viewBox="0 0 16 16" alt="GitHub" aria-label="GitHub"><path fill="currentColor" d="m8 0.431c-4.28 0-7.76 3.47-7.76 7.76 0 3.43 2.22 6.34 5.31 7.36 0.388 0.071 0.53-0.168 0.53-0.374 0-0.184-0.007-0.672-0.01-1.32-2.16 0.469-2.61-1.04-2.61-1.04-0.353-0.896-0.862-1.14-0.862-1.14-0.705-0.481 0.053-0.472 0.053-0.472 0.779 0.055 1.19 0.8 1.19 0.8 0.692 1.19 1.82 0.843 2.26 0.645 0.071-0.502 0.271-0.843 0.493-1.04-1.73-0.3-3.54-0.9-3.54-3.91 0-0.847 0.302-1.54 0.799-2.08-0.08-0.2-0.35-0.99 0.07-2.06 0 0 0.652-0.209 2.13 0.796 0.63-0.18 1.29-0.26 1.95-0.27 0.659 0.003 1.32 0.089 1.94 0.261 1.48-1 2.13-0.796 2.13-0.796 0.423 1.07 0.157 1.86 0.077 2.05 0.497 0.542 0.798 1.24 0.798 2.08 0 2.98-1.81 3.64-3.54 3.83 0.279 0.24 0.527 0.713 0.527 1.44 0 1.04-0.01 1.87-0.01 2.13 0 0.208 0.14 0.449 0.534 0.373 3.08-1.03 5.3-3.94 5.3-7.36 0-4.23-3.5-7.71-7.8-7.71z"></path></svg> wchargin</a><br/><span>email me @gmail.com</span></div></footer></div></div>
</body>
</html>
