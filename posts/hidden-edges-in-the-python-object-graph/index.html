<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="shortcut icon" href="/favicon.png" sizes="16x16" />
<link rel="shortcut icon" href="/favicon-256.png" sizes="256x256" />
<link rel="apple touch icon" href="/favicon-256.png" />
<title>Hidden edges in the Python object graph</title>
<style>/*! normalize.css v4.1.1 | MIT License | github.com/necolas/normalize.css */
html{font-family:sans-serif;line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress,sub,sup{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline dotted}b,strong{font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,hr,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{color:inherit;display:table;max-width:100%;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio],legend{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}</style>
<style>p{margin-top:0}</style>
<style>code .comment{color:#6e6e6e}code:not([data-hide-strings]) .string{color:#6e6e6e}code .important{font-style:italic}code .keyword{font-weight:700}code .prompt,code .tt{font-family:monospace}code .prompt{user-select:none}code .property,code .property+.punctuation{font-weight:700}code .tag .tag:first-child{font-weight:700}code .punctuation{font-weight:400}</style>
<style data-aphrodite>._684hqj{font-family:Helvetica, Arial, sans-serif;font-size:16px;color:#121316;line-height:1.5;}._12iqsw5{position:fixed;z-index:-1;top:0px;bottom:0px;width:-webkit-calc(max(400px, 50vw - 420px));width:-moz-calc(max(400px, 50vw - 420px));width:calc(max(400px, 50vw - 420px));left:-webkit-calc(50vw - 420px - max(400px, 50vw - 420px));left:-moz-calc(50vw - 420px - max(400px, 50vw - 420px));left:calc(50vw - 420px - max(400px, 50vw - 420px));background:url(/static/skygradopaque.d6e5e82bc642.jpg), -webkit-linear-gradient(to bottom, #9eabbc 0%, #aebbc3 47%, #c1c0b4 73%, #c3af97 89%, #bd987e 100%);background:url(/static/skygradopaque.d6e5e82bc642.jpg), -moz-linear-gradient(to bottom, #9eabbc 0%, #aebbc3 47%, #c1c0b4 73%, #c3af97 89%, #bd987e 100%);background:url(/static/skygradopaque.d6e5e82bc642.jpg), linear-gradient(to bottom, #9eabbc 0%, #aebbc3 47%, #c1c0b4 73%, #c3af97 89%, #bd987e 100%);background-size:100% 100%;-webkit-mask-image:-webkit-linear-gradient(to right, rgb(0 0 0 / 100%), rgb(0 0 0 / 50%) 25%, transparent);-webkit-mask-image:-moz-linear-gradient(to right, rgb(0 0 0 / 100%), rgb(0 0 0 / 50%) 25%, transparent);-webkit-mask-image:linear-gradient(to right, rgb(0 0 0 / 100%), rgb(0 0 0 / 50%) 25%, transparent);mask-image:-webkit-linear-gradient(to right, rgb(0 0 0 / 100%), rgb(0 0 0 / 50%) 25%, transparent);mask-image:-moz-linear-gradient(to right, rgb(0 0 0 / 100%), rgb(0 0 0 / 50%) 25%, transparent);mask-image:linear-gradient(to right, rgb(0 0 0 / 100%), rgb(0 0 0 / 50%) 25%, transparent);}._1qcuqeh{position:absolute;z-index:-1;top:0px;right:-webkit-calc(50vw + 420px);right:-moz-calc(50vw + 420px);right:calc(50vw + 420px);opacity:0.25;}._37ihjp{border-top:#046375 5px solid;border-bottom:0.5px #cecece solid;margin-bottom:24px;padding-top:10px;padding-bottom:10px;}._tcz2umt{-webkit-box-align:center;-ms-flex-align:center;-webkit-box-pack:justify;-ms-flex-pack:justify;max-width:800px;margin:auto;padding-left:20px;padding-right:20px;display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;align-items:center;margin-top:10px;margin-bottom:10px;}._odt2os{font-size:24px;letter-spacing:-0.5px;color:#222;}._1yyogy7{max-width:800px;margin:auto;padding-left:20px;padding-right:20px;}._1gtwn3{color:#6e6e6e;border-top:0.5px #cecece solid;margin-top:24px;padding-top:24px;padding-bottom:24px;}._16597jh{text-decoration:none;color:#0a7f96;}._16597jh:hover{color:#046375;text-decoration:underline;}._16597jh:active{color:#0a7f96;text-decoration:underline;}._1rq9psi{list-style:none;padding-left:0px;margin:0px;}._txtyvv{display:inline;margin-left:20px;}._nqjtz2{margin-top:30px;margin-bottom:10px;font-size:32px;font-weight:normal;}._1ucarsym{font-family:Helvetica,Arial,sans-serif;padding:2px 4px;background:rgba(10,127,150,0.1);white-space:pre-wrap;}._gy9i19{margin:16px;overflow-x:auto;background:rgba(10,127,150,0.1);border-left:#0a7f96 2px solid;padding:16px;line-height:140%;}._1napz9l{font-family:Helvetica,Arial,sans-serif;}._1htp0dj{margin-top:26px;margin-bottom:8px;font-size:24px;font-weight:normal;}</style>
<noscript><style>.yesscript{display:none;}</style></noscript>
</head>
<body style="overflow-y:scroll">
<div id="container"><div class="_684hqj"><div class="_12iqsw5"></div><img class="_1qcuqeh" src="/static/leaves.adfcead73f2e.png" width="226" height="400" alt=""/><header class="_37ihjp"><nav class="_tcz2umt"><a class="_odt2os _16597jh" href="/">Willow Chargin</a><ul class="_1rq9psi"><li class="_txtyvv"><a class="_16597jh" href="/"><svg width="14" height="14" viewBox="0 0 16 16" alt="Home" aria-label="Home"><path fill="currentColor" d="M15.45,7L14,5.551V2c0-0.55-0.45-1-1-1h-1c-0.55,0-1,0.45-1,1v0.553L9,0.555C8.727,0.297,8.477,0,8,0S7.273,0.297,7,0.555  L0.55,7C0.238,7.325,0,7.562,0,8c0,0.563,0.432,1,1,1h1v6c0,0.55,0.45,1,1,1h3v-5c0-0.55,0.45-1,1-1h2c0.55,0,1,0.45,1,1v5h3  c0.55,0,1-0.45,1-1V9h1c0.568,0,1-0.437,1-1C16,7.562,15.762,7.325,15.45,7z"></path></svg></a></li><li class="_txtyvv"><a class="_16597jh" href="/posts/">Posts</a></li></ul></nav></header><article class="_1yyogy7"><div><a style="margin-bottom:10px;margin-top:10px" class="_16597jh" href="/posts"><i>« back to posts</i></a><article><div><h1 class="_nqjtz2">Hidden edges in the Python object graph</h1><p><i>2019-03-08</i> <!-- -->·<!-- --> <i><a href="https://github.com/wchargin/wchargin.github.io/blob/source/src/pages/posts/data/pythonMemoryNavigation.js" class="_16597jh">view article source</a></i></p></div><p>It’s well known that Python doesn’t really have a concept of private data. Underscore-named attributes are nothing more than a convention; anyone can access them, and they can leak implementation details across class boundaries in a way that (say) private fields in Java can’t.</p><p>When actual encapsulation is desired—say, to prevent leaking new attributes onto an object—a common practice is to use a closure to <em>capture</em> the desired the value rather than assigning it to an attribute. For instance, in the following code, it might seem unlikely that we could implement <code class="_1ucarsym">callback</code> such that the program always completes successfully:</p><pre class="_gy9i19"><code class="_1napz9l"><span class="token keyword">def</span> make_greeter(expected_name):
    <span class="token tqs string">"""Return a function that expects to greet a very specific guest."""</span>
    <span class="token keyword">def</span> greet(actual_name):
        <span class="token keyword">if</span> expected_name != actual_name:
            <span class="token keyword">raise</span> ValueError(<span class="token string">"Who are you?"</span>)
        <span class="token keyword">else</span>:
            <span class="token keyword">print</span>(<span class="token string">"Hello, %s!"</span> % actual_name)
    <span class="token keyword">return</span> greet

<span class="token keyword">def</span> greet_guest(greet, choose_guest):
    guest = choose_guest()
    greet(guest)

<span class="token keyword">def</span> main():
    greet_guest(make_greeter(input()), callback)

<span class="token keyword">def</span> callback():
    <span class="token comment"># Wherever to begin?</span>
    <span class="token keyword">raise</span> NotImplementedError()

<span class="token keyword">if</span> __name__ == <span class="token string">"__main__"</span>:
    main()
</code></pre><p>But in fact we can, with the help of two “features” of Python dynamism. The following definition suffices:</p><pre class="_gy9i19"><code class="_1napz9l"><span class="token keyword">def</span> callback():
    <span class="token keyword">import</span> inspect
    parent_frame = inspect.stack()[1].frame
    greeter = parent_frame.f_locals[<span class="token string">"greet"</span>]
    expected_name = greeter.__closure__[0].cell_contents
    <span class="token keyword">return</span> expected_name
</code></pre><h2 class="_1htp0dj">What?</h2><p>In case it’s not clear, here’s what’s going on. We first introspect the runtime environment to traverse up the call stack, and obtain a reference to our caller’s activation record. This includes our caller’s local variables, which are conveniently keyed by name, so we can easily grab whatever <code class="_1ucarsym">greet</code> function was passed into <code class="_1ucarsym">greet_guest</code>. Finally, we can directly access that function’s closure environment, pulling the contents of the first (and only) value over which it closes.</p><p>In Python 2, the syntax is a bit different—<code class="_1ucarsym">parent_frame</code> is just a tuple, so replace <code class="_1ucarsym">.frame</code> with <code class="_1ucarsym">[0]</code>; and <code class="_1ucarsym">__closure__</code> is instead called <code class="_1ucarsym">func_closure</code>. The semantics, however, are the same.</p><p>In case you were wondering, Python at least has the good sense to make local variable dictionaries and closure cells read-only, so you can’t completely wreak havoc.</p><h2 class="_1htp0dj">Why?</h2><p>While this code probably isn’t quite ready for production, it can be useful in a pinch when you want to inspect a running Python process. For instance, I used the following incantation at a REPL to get the details of a particularly hard-to-access value that was being mutated by the Python import system:</p><pre class="_gy9i19"><code class="_1napz9l"><span class="token keyword">import</span> inspect
<span class="token keyword">print</span>(inspect.getsource(
    type(tensorboard.program)  <span class="token comment"># a dynamically generated class…</span>
        .__getattr__  <span class="token comment"># …whose member function closes over…</span>
        .__closure__[0].cell_contents  <span class="token comment"># …a decorated function…</span>
        .__closure__[1].cell_contents  <span class="token comment"># …whose underlying function…</span>
        .__closure__[0].cell_contents  <span class="token comment"># …contains a value of interest!</span>
))
</code></pre><p>Sure, it requires knowing the memory layout pretty well ahead of time—but hey, it works!</p><h2 class="_1htp0dj">Is nothing secret?</h2><p>So, closure-captured values and locals in ancestor function calls are accessible. This works even across threads, because <code class="_1ucarsym">sys._current_frames()</code> gives references to stack frame objects for all running threads, and a frame reference is all we need to perform the traversals above. Are there any places that we can stash a value such that later code can’t access it? At the very least, values that are never bound to a name look pretty safe: in <code class="_1ucarsym">print(input() + callback())</code>, the body of <code class="_1ucarsym">callback</code> will be hard-pressed to discover the result of <code class="_1ucarsym">input()</code>.</p><p>Python, of course, thwarts any such attempt at sanity by directly providing <code class="_1ucarsym">gc.get_objects()</code>, which returns a list of all objects tracked by the garbage collector. This almost suffices, except that some values aren’t tracked by the garbage collector (e.g., <code class="_1ucarsym">dict</code>s containing only atomic keys and values), so this isn’t quite good enough. While a definitive answer proves elusive, one conclusion seems clear: if for some reason you find yourself wanting to make the assumption that you can effectively isolate a piece of secret memory from untrusted Python code running in the same process… don’t!</p></article><a style="margin-bottom:10px;margin-top:10px" class="_16597jh" href="/posts"><i>« back to posts</i></a></div></article><footer class="_1gtwn3"><div class="_1yyogy7"><a href="https://github.com/wchargin" class="_16597jh"><svg width="16" height="16" style="vertical-align:middle" viewBox="0 0 16 16" alt="GitHub" aria-label="GitHub"><path fill="currentColor" d="m8 0.431c-4.28 0-7.76 3.47-7.76 7.76 0 3.43 2.22 6.34 5.31 7.36 0.388 0.071 0.53-0.168 0.53-0.374 0-0.184-0.007-0.672-0.01-1.32-2.16 0.469-2.61-1.04-2.61-1.04-0.353-0.896-0.862-1.14-0.862-1.14-0.705-0.481 0.053-0.472 0.053-0.472 0.779 0.055 1.19 0.8 1.19 0.8 0.692 1.19 1.82 0.843 2.26 0.645 0.071-0.502 0.271-0.843 0.493-1.04-1.73-0.3-3.54-0.9-3.54-3.91 0-0.847 0.302-1.54 0.799-2.08-0.08-0.2-0.35-0.99 0.07-2.06 0 0 0.652-0.209 2.13 0.796 0.63-0.18 1.29-0.26 1.95-0.27 0.659 0.003 1.32 0.089 1.94 0.261 1.48-1 2.13-0.796 2.13-0.796 0.423 1.07 0.157 1.86 0.077 2.05 0.497 0.542 0.798 1.24 0.798 2.08 0 2.98-1.81 3.64-3.54 3.83 0.279 0.24 0.527 0.713 0.527 1.44 0 1.04-0.01 1.87-0.01 2.13 0 0.208 0.14 0.449 0.534 0.373 3.08-1.03 5.3-3.94 5.3-7.36 0-4.23-3.5-7.71-7.8-7.71z"></path></svg> wchargin</a><br/><span>email me @gmail.com</span></div></footer></div></div>
</body>
</html>
